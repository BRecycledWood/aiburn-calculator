name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Security: Dependency scanning
  security-scan:
    runs-on: ubuntu-latest
    name: Security Scanning
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      - name: Run npm audit
        run: npm audit --audit-level=high --production
        continue-on-error: true
      
      - name: Check for secrets in code
        run: |
          # Basic check for AWS keys and API keys
          ! grep -r "AKIA[0-9A-Z]\{16\}" . --exclude-dir=node_modules
          ! grep -r "sk-[A-Za-z0-9-]\{20,\}" . --exclude-dir=node_modules --exclude-dir=.git
          echo "‚úì No secrets detected in code"

  # Linting
  lint:
    runs-on: ubuntu-latest
    name: Lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      - name: Lint code
        run: npm run lint || true
        continue-on-error: true

  # Unit Tests
  test:
    runs-on: ubuntu-latest
    name: Unit Tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      - name: Run unit tests
        run: npm run test:ci
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # Build
  build:
    runs-on: ubuntu-latest
    name: Build
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      - name: Build application
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
      
      - name: Validate bundle size
        run: |
          BUNDLE_SIZE=$(du -sh dist/ | cut -f1)
          echo "üì¶ Bundle size: $BUNDLE_SIZE"
          
          # Alert if bundle is too large (>1MB)
          SIZE_BYTES=$(du -sb dist/ | cut -f1)
          if [ $SIZE_BYTES -gt 1048576 ]; then
            echo "‚ö†Ô∏è Bundle size is larger than 1MB"
          fi
      
      - name: Check for secrets in bundle
        run: |
          if grep -r "sk-[A-Za-z0-9-]\{20,\}" dist/ 2>/dev/null; then
            echo "‚ùå ERROR: API keys found in bundle"
            exit 1
          fi
          if grep -r "AKIA[0-9A-Z]\{16\}" dist/ 2>/dev/null; then
            echo "‚ùå ERROR: AWS keys found in bundle"
            exit 1
          fi
          echo "‚úì No secrets in build output"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist
          path: dist/
          retention-days: 7

  # E2E Tests
  e2e:
    runs-on: ubuntu-latest
    name: E2E Tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      
      - name: Run E2E tests
        run: npm run e2e
      
      - name: Upload E2E test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-results
          path: test-results/
          retention-days: 7

  # Post-Deploy Smoke Tests (optional, runs on main branch only)
  smoke-test:
    runs-on: ubuntu-latest
    name: Smoke Tests
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Run smoke tests
        run: node scripts/smoke-test.js ${{ secrets.PRODUCTION_URL }}
        env:
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}

  # GitHub Status Check - BLOCKING
  ci-status:
    runs-on: ubuntu-latest
    needs: [security-scan, lint, test, build, e2e]
    if: always()
    name: CI Status Check
    steps:
      - name: Check all job statuses
        run: |
          SECURITY_STATUS="${{ needs.security-scan.result }}"
          LINT_STATUS="${{ needs.lint.result }}"
          TEST_STATUS="${{ needs.test.result }}"
          BUILD_STATUS="${{ needs.build.result }}"
          E2E_STATUS="${{ needs.e2e.result }}"
          
          echo "CI Pipeline Status Report"
          echo "========================="
          echo "üîê Security Scan:     $SECURITY_STATUS"
          echo "üìù Lint:              $LINT_STATUS"
          echo "üß™ Unit Tests:        $TEST_STATUS"
          echo "üì¶ Build:             $BUILD_STATUS"
          echo "üé≠ E2E Tests:         $E2E_STATUS"
          echo ""
          
          if [ "$SECURITY_STATUS" != "success" ] || [ "$LINT_STATUS" != "success" ] || [ "$TEST_STATUS" != "success" ] || [ "$BUILD_STATUS" != "success" ] || [ "$E2E_STATUS" != "success" ]; then
            echo "‚ùå CI PIPELINE FAILED - PR CANNOT BE MERGED"
            exit 1
          fi
          echo "‚úÖ CI PIPELINE PASSED - All checks successful"
