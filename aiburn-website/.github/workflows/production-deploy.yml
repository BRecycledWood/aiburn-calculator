name: Production Deploy

on:
  push:
    branches: [main]

jobs:
  verify:
    name: Pre-Deployment Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install --legacy-peer-deps
      
      - name: Run security checks
        run: |
          echo "Running security checks..."
          npm audit --audit-level=moderate || true
          npm run lint || true
      
      - name: Run tests
        run: npm test -- --coverage --watchAll=false
      
      - name: Build for production
        run: npm run build
      
      - name: Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "❌ Build failed: dist directory not found"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "❌ Build failed: index.html not found"
            exit 1
          fi
          
          SIZE=$(du -sh dist | cut -f1)
          echo "✅ Build successful. Size: $SIZE"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: verify
    if: success()
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Vercel
        uses: vercel/action@main
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          production: true
      
      - name: Create deployment notification
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: 'production',
              auto_merge: false,
              required_contexts: [],
              description: 'Production deployment via GitHub Actions'
            });

  post-deploy-checks:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    steps:
      - name: Health Check
        run: |
          echo "Checking production endpoint..."
          curl -f https://aiburn.howstud.io/ > /dev/null || exit 1
          echo "✅ Production health check passed"
      
      - name: Security Headers Check
        run: |
          echo "Verifying security headers..."
          curl -I https://aiburn.howstud.io/ | grep -q "Content-Security-Policy" && echo "✅ CSP header present" || echo "⚠️ CSP header missing"
          curl -I https://aiburn.howstud.io/ | grep -q "Strict-Transport-Security" && echo "✅ HSTS header present" || echo "⚠️ HSTS header missing"
      
      - name: Create success comment
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: '✅ **Production Deployment Successful**\n\n- All QC checks passed\n- Build verified\n- Deployed to https://aiburn.howstud.io\n- Health checks passed'
            });

  notify-slack:
    name: Slack Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: Notify Slack on Success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "✅ AIBurn Production Deployment Successful",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "✅ Production Deployment"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Status:* Successful\n*App:* AIBurn Cost Calculator\n*URL:* https://aiburn.howstud.io\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}"
                  }
                }
              ]
            }
      
      - name: Notify Slack on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "❌ AIBurn Production Deployment Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "❌ Production Deployment Failed"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*App:* AIBurn Cost Calculator\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}\n*Action:* https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
