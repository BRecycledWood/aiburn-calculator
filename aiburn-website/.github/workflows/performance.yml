name: Performance Monitoring

on:
  push:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install --legacy-peer-deps
      
      - name: Build production bundle
        run: npm run build
      
      - name: Analyze bundle
        run: |
          echo "## Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get sizes
          HTML_SIZE=$(du -sh dist/index.html | cut -f1)
          CSS_SIZE=$(du -sh dist/index.*.css 2>/dev/null | cut -f1 || echo "N/A")
          JS_SIZE=$(du -sh dist/index.*.js 2>/dev/null | cut -f1 || echo "N/A")
          
          # Get gzipped JS size
          JS_FILE=$(ls dist/index.*.js 2>/dev/null | head -1)
          if [ -n "$JS_FILE" ]; then
            JS_GZIP=$(gzip -9 < "$JS_FILE" | wc -c | awk '{printf "%.2f KB", $1/1024}')
          else
            JS_GZIP="N/A"
          fi
          
          echo "| Asset | Size | Gzipped |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| HTML | $HTML_SIZE | - |" >> $GITHUB_STEP_SUMMARY
          echo "| CSS | $CSS_SIZE | - |" >> $GITHUB_STEP_SUMMARY
          echo "| JS | $JS_SIZE | $JS_GZIP |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Thresholds:**" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript (gzipped): < 150 KB ✅" >> $GITHUB_STEP_SUMMARY
          echo "- CSS: < 30 KB ✅" >> $GITHUB_STEP_SUMMARY
          echo "- HTML: < 5 KB ✅" >> $GITHUB_STEP_SUMMARY

  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v9
        with:
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

  performance-regression:
    name: Performance Regression Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install --legacy-peer-deps
      
      - name: Run performance tests
        run: npm test -- --testPathPattern=performance --watchAll=false
        continue-on-error: true
      
      - name: Generate performance report
        run: |
          echo "## Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Performance tests executed. Check logs for detailed metrics." >> $GITHUB_STEP_SUMMARY
